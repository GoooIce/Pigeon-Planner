name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

# å¢å¼ºæƒé™é…ç½®
permissions:
  contents: write
  packages: write
  actions: read

jobs:

  build-linux:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4

    - name: Display runner environment information
      run: |
        echo "=== Runner Environment Information ==="
        echo "Runner OS: ${{ runner.os }}"
        echo "Runner Name: ${{ runner.name }}"
        echo "Runner Architecture: $(uname -m)"
        echo "Working Directory: $(pwd)"
        echo "User: $(whoami)"
        echo ""
        echo "=== System Information ==="
        echo "OS Release:"
        cat /etc/os-release 2>/dev/null || echo "OS release info not available"
        echo ""
        echo "Kernel: $(uname -r)"
        echo ""
        echo "=== Required Tools Check ==="
        echo -n "Node.js: "
        node --version 2>/dev/null || echo "NOT INSTALLED"
        echo -n "npm: "
        npm --version 2>/dev/null || echo "NOT INSTALLED"
        echo -n "Rust: "
        rustc --version 2>/dev/null || echo "NOT INSTALLED"
        echo -n "Cargo: "
        cargo --version 2>/dev/null || echo "NOT INSTALLED"
        echo ""
        echo "=== Permissions Check ==="
        echo -n "Sudo access: "
        sudo -n true 2>/dev/null && echo "AVAILABLE" || echo "CHECKING..."
        echo -n "Write permission in workspace: "
        touch test_write_permission.txt 2>/dev/null && rm test_write_permission.txt && echo "OK" || echo "FAILED"
        echo ""
        echo "=== Disk Space ==="
        df -h . | tail -1
        echo ""
        echo "=== Environment Variables ==="
        echo "HOME: $HOME"
        echo "USER: $USER"
        echo "PATH: $PATH"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          pigeon-planner-rs/package-lock.json
          pigeon-planner-rs/package.json

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-gnu

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ${{ github.workspace }}/pigeon-planner-rs/target
        key: ${{ runner.os }}-self-hosted-cargo-${{ hashFiles('pigeon-planner-rs/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-self-hosted-cargo-

    - name: Check and install system dependencies
      run: |
        echo "ğŸ“¦ Checking system dependencies..."
        
        # Check if sudo is available
        if ! command -v sudo &> /dev/null; then
          echo "âš ï¸ sudo not found, trying without sudo..."
          SUDO_CMD=""
        else
          # Test sudo access
          if sudo -n true 2>/dev/null; then
            echo "âœ… Sudo access available (passwordless)"
            SUDO_CMD="sudo"
          else
            echo "âš ï¸ Sudo requires password, attempting with sudo..."
            SUDO_CMD="sudo"
          fi
        fi
        
        # Check if packages are already installed (for self-hosted runners)
        MISSING_PACKAGES=()
        for pkg in libwebkit2gtk-4.0-dev build-essential curl wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev; do
          if ! dpkg -l | grep -q "^ii  $pkg "; then
            MISSING_PACKAGES+=("$pkg")
          fi
        done
        
        if [ ${#MISSING_PACKAGES[@]} -eq 0 ]; then
          echo "âœ… All required packages are already installed"
        else
          echo "ğŸ“¦ Installing missing packages: ${MISSING_PACKAGES[*]}"
          $SUDO_CMD apt-get update
          $SUDO_CMD apt-get install -y "${MISSING_PACKAGES[@]}"
        fi

    - name: Install dependencies
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        
        # Check if tauri-cli is already installed (for self-hosted runners)
        if command -v tauri &> /dev/null; then
          echo "âœ… tauri-cli is already installed: $(tauri --version)"
        else
          echo "ğŸ“¦ Installing tauri-cli..."
          cargo install tauri-cli
        fi
        
        # Install npm dependencies
        echo "ğŸ“¦ Installing npm dependencies..."
        npm install

    - name: TypeScript check
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ” Running TypeScript type check..."
        npx tsc --noEmit --pretty || {
          echo "âŒ TypeScript check failed"
          echo "âš ï¸ Continuing build for now, but TypeScript errors should be fixed"
        }

    - name: Lint check
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ” Running linter..."
        npm run lint || {
          echo "âš ï¸ Lint check failed, but continuing build"
        }

    - name: Build frontend
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        npm run build
        echo "âœ… Frontend build completed"

    - name: Build app
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ§ Building Linux version..."
        npm run tauri build --target x86_64-unknown-linux-gnu

    - name: Verify build artifacts
      working-directory: ./pigeon-planner-rs
      run: |
        echo "ğŸ” Verifying build artifacts..."
        ls -la target/release/bundle/deb/ || echo "âš ï¸ DEB directory not found"
        ls -la target/release/bundle/appimage/ || echo "âš ï¸ AppImage directory not found"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-builds
        path: |
          pigeon-planner-rs/target/release/bundle/deb/
          pigeon-planner-rs/target/release/bundle/appimage/